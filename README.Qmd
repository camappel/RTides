---
title: "Harmonic Analysis of Tides"
format: gfm
---
```{r}
library(magrittr)
library(lubridate)
library(ggplot2)
library(dplyr)
```

## Data

## Data
### [NOAA](https://tidesandcurrents.noaa.gov/) Tides & Currents

| Field | Value |
|----|----|
| Station name | Southbank Riverwalk, St Johns River (8720226) |
| Location | Jacksonville, FL, USA |
| Latitude | 30° 19.2’ N |
| Longitude | 81° 39.5’ W |
| Datum reference | [MLLW = MSL - 1.06 m]((https://tidesandcurrents.noaa.gov/datums.html?id=8720226)) |
| Time reference | EST |
| Resolution | 6-minutes |
| Units | “Standard” (f) or Metric (m) |
| Predicted tide | [Harmonic](https://tidesandcurrents.noaa.gov/education/tech-assist/training/user-guides/assets/pdfs/Tide_Predictions_User_Guide_v4.pdf) |
| Verified (observed) tide | preliminary: not quality controlled available up to todays date; **verified: quality controlled – month to year behind)** |

<img width="602" height="453" alt="Screenshot 2025-11-03 at 23 27 34" src="https://github.com/user-attachments/assets/15044e81-a9f4-4408-8349-984a9722b3bd" />

A tidal datum can be thought of as an imaginary fixed plane, or benchmark, relative to which we measure depths. Different regions and datasets use different datums.

The NOAA station uses Mean Lower-Low Water (MLLW) as its zero:
- Mean Lower Low Water (MLLW) = "The average of the lower low water height of each tidal day observed over the National Tidal Datum Epoch"
- Mean Sea Level (MSL) = "The arithmetic mean of hourly heights observed over the National Tidal Datum Epoch."
- MLLW = MSL - 1.06 m @ Southbank Riverwalk
- National Tidal Datum Epoch = "The specific 19-year period adopted by the National Ocean Service as the official time segment over which tide observations are taken and reduced to obtain mean values (e.g., mean lower low water, etc.) for tidal datums. It is necessary for standardization because of periodic and apparent secular trends in sea level. The present NTDE is 1983 through 2001 and is actively considered for revision every 20-25 years."

### [British Oceanographic Data Centre](https://www.bodc.ac.uk/data/hosted_data_systems/sea_level/uk_tide_gauge_network/) - UK Tide Gauge Network

| Field           | Value              |
|-----------------|--------------------|
| Station name    | Portsmouth         |
| Location        | UK                 |
| Latitude        | 50° 48’ N          |
| Longitude       | 01° 06’ W          |
| Datum reference | ACD = ODN − 2.73 m |
| Time reference  | GMT                |
| Resolution      | 15-minutes         |
| Units           | Metric (m)         |
| ASLVBG02        | Observed surface elevation from bubbler gauge relative to ACD |
| Residual        | The measured height minus the predicted height. The predicted values are derived from a database of tidal constants maintained by the National Oceanography Centre Application Group. All values are relative to Admiralty Chart Datum (ACD) |
| Surges          | Extreme surges are the maximum and minimum tidal residuals | 

<img width="721" height="386" alt="image" src="https://github.com/user-attachments/assets/e4653ba1-13f2-4f37-8c04-9ae130084201" />

- The UK national levelling network expresses heights in terms of ODN = average level of the sea at Newlyn (southwest England) 1915–21.
- Most published tide tables in Great Britain use the [Admiralty Chart Datum (ACD)](https://ntslf.org/tides/datum), which is the lowest level due to astronomical effects and excluding meteorological effects below the UK national height reference ODN.
- In Portsmouth, this is 2.73m below the ODN.

## Load data

The raw data files for Portsmouth and Jacksonville are stored in `data/`.
```{r}
library(httr)

base <- "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter"
params <- list(
  begin_date = "20230101",
  end_date   = "20231231",
  station    = "8720226",
  product    = "hourly_height",   # use 'water_level' for 6-min; then do month by month
  datum      = "MLLW",
  time_zone  = "gmt",
  units      = "metric",
  format     = "csv",
  application= "RTides"
)

resp <- GET(base, query = params)
# JSON -> R list
data <- content(resp, "text", encoding = "UTF-8")
data <- read.csv(text = data, stringsAsFactors = FALSE)
# Print first and last 5 rows in one table
library(knitr)
n <- 5
nrows <- nrow(data)
if (nrows <= 2 * n) {
  show_data <- data
} else {
  show_data <- rbind(
    head(data, n),
    setNames(rep(list(rep("...")), ncol(data)), names(data)),
    tail(data, n)
  )
}
kable(show_data)
```

```{r}
fl_time <- as.POSIXct(data$Date.Time, tz = "UTC")
fl <- data.frame(time = fl_time, elevation = as.numeric(data$Water.Level))

# Plot a week of tide curves (first 7 days) on the same chart, color by day
library(dplyr)
library(lubridate)
library(ggplot2)

fl_week <- fl %>%
  filter(time >= as.POSIXct("2023-01-01 00:00:00", tz = "UTC") &
         time < as.POSIXct("2023-01-08 00:00:00", tz = "UTC")) %>%
  mutate(day = as.Date(time))

ggplot(fl_week, aes(x = format(time, "%H:%M"), y = elevation, color = factor(day), group = day)) +
  geom_line() +
  labs(
    title = "Jacksonville Water Level — First Week of 2023",
    x = "Hour of Day",
    y = "Water Level (m, MLLW datum)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none"
  )
```
```{r}
ggplot(fl, aes(x = time, y = elevation)) +
  geom_line(color = "steelblue") +
  labs(
    title = "Jacksonville Water Level — 2023",
    x = "Time",
    y = "Water Level (m, MLLW datum)"
  ) +
  theme_minimal()
```


```{r}
# Read CSV (expected columns: date, time, elevation)
portsmouth_raw <- read.csv("data/Portsmouth.csv", stringsAsFactors = FALSE)

# Build POSIXct timestamps (minute resolution) 
portsmouth_time <- as.POSIXct(
  paste(portsmouth_raw$date, portsmouth_raw$time),
  tz = "UTC"
)
portsmouth_msl <- data.frame(time = portsmouth_time, elevation = as.numeric(portsmouth_raw$elevation))

# Filter for first 7 days of 2023 and add a 'day' column
portsmouth_week <- portsmouth_msl %>%
  filter(time >= as.POSIXct("2023-01-01 00:00:00", tz = "UTC") &
         time < as.POSIXct("2023-01-08 00:00:00", tz = "UTC")) %>%
  mutate(day = as.Date(time))

ggplot(portsmouth_week, aes(x = time, y = elevation, color = factor(day), group = day)) +
  geom_line() +
  labs(
    title = "Portsmouth Water Level — First Week of 2023",
    x = "Hour of Day",
    y = "Water Level (m, ADC datum)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none"
  )
```
```{r}

ggplot(portsmouth_msl, aes(x = time, y = elevation)) +
  geom_line(color = "steelblue") +
  labs(
    title = "Portsmouth Water Level — 2023",
    x = "Time",
    y = "Water Level (m, MSL datum)"
  ) +
  theme_minimal()
```

### [British Oceanographic Data Centre](https://www.bodc.ac.uk/data/hosted_data_systems/sea_level/uk_tide_gauge_network/) - UK Tide Gauge Network

| Field           | Value              |
|-----------------|--------------------|
| Station name    | Sheerness          |
| Location        | UK                 |
| Latitude        | 51° 27′ N          |
| Longitude       | 0° 45   E          |
| Time reference  | GMT                |
| Resolution      | 15-minutes         |
| Units           | Metric (m)         |
| ASLVBG02        | Observed surface elevation from bubbler gauge relative to ACD |
| Residual        | The measured height minus the predicted height. The predicted values are derived from a database of tidal constants maintained by the National Oceanography Centre Application Group. All values are relative to Admiralty Chart Datum (ACD) |
| Surges          | Extreme surges are the maximum and minimum tidal residuals | 

<img width="721" height="386" alt="image" src="https://github.com/user-attachments/assets/e4653ba1-13f2-4f37-8c04-9ae130084201" />

- The UK national levelling network expresses heights in terms of ODN = average level of the sea at Newlyn (southwest England) 1915–21.
- Most published tide tables in Great Britain use the [Admiralty Chart Datum (ACD)](https://ntslf.org/tides/datum), which is the lowest level due to astronomical effects and excluding meteorological effects below the UK national height reference ODN.
- In Portsmouth, this is 2.73m below the ODN.

## Load data

```{r}
sheerness_raw <- read.csv("data/Sheerness_13-14.csv", stringsAsFactors = FALSE)

extreme_water_levels <- sheerness_raw %>%
  group_by(date) %>%
  slice_max(order_by = elevation, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(desc(elevation)) %>%
  head(10) %>%
  select(date, time, elevation, residual)

extreme_water_levels %>%
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>%
  arrange(date)
```

```{r}
sheerness_raw$predicted <- sheerness_raw$elevation - sheerness_raw$residual

# Filter data for date range 2014-12-13 to 2014-12-17 (smoothing applied)
sheerness_raw$datetime <- as.POSIXct(paste(sheerness_raw$date, sheerness_raw$time), format = "%Y/%m/%d %H:%M:%S", tz = "GMT")
date_start <- as.POSIXct("2014-12-13", tz = "GMT")
date_end <- as.POSIXct("2014-12-17 23:59:59", tz = "GMT")

sheerness_period <- sheerness_raw %>%
  filter(datetime >= date_start, datetime <= date_end)

# Aggregate (average) observed and predicted water levels hourly
sheerness_period$hour <- lubridate::floor_date(sheerness_period$datetime, unit = "hour")
sheerness_hourly <- sheerness_period %>%
  group_by(hour) %>%
  summarise(
    elevation = mean(elevation, na.rm = TRUE),
    predicted = mean(predicted, na.rm = TRUE)
  ) %>%
  ungroup()

# Print out the table (optional)
print(sheerness_hourly)

library(tidyr)
sheerness_long <- sheerness_hourly %>%
  pivot_longer(cols = c(elevation, predicted),
               names_to = "type",
               values_to = "value")

# Plot with default widths (removing knitr and fig-width comments)
ggplot(sheerness_long, aes(x = hour, y = value, color = type)) +
  geom_line(size = 1) +
  labs(
    title = "Sheerness: Hourly-Averaged Observed vs Predicted Water Levels (2014-12-13 to 2014-12-17)",
    x = "Datetime (GMT, hourly)",
    y = "Water Level (m, ACD datum)",
    color = "Legend"
  ) +
  theme_minimal()

```